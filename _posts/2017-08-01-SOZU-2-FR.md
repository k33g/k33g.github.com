---

layout: post
title: SOZU, le reverse-proxy magique, Partie 2
info : La suite de l'article pr√©c√©dent, une version o√π vous n'avez presque rien √† faire
teaser: une d√©mo SOZU, o√π vous n'avez presque rien √† faire
---

# S≈çzu, 1ers pas, 2√®me partie

Dans un pr√©c√©dent article j'expliquais comment d√©buter avec **S≈çzu**. (c'est par ici [http://k33g.github.io/2017/07/29/SOZU-1-FR.html](http://k33g.github.io/2017/07/29/SOZU-1-FR.html)) avec plein de manipulations, de code, , de compilation, etc... √† taper. Donc aujourd'hui je reviens avec une version d√©mo un peu plus packag√©e pour que vous n'ayez presque rien √† faire. M√™me la compilation de S≈çzu se fera toute seule.

## Pr√©-requis

- Installer VirtualBox
- Installer Vagrant
- Cl√¥ner ce projet : [https://github.com/k33g/sozu-vagrant-demo](https://github.com/k33g/sozu-vagrant-demo) (faites ceci `git clone git@github.com:k33g/sozu-vagrant-demo.git`)

## Lancement

```shell
cd sozu-vagrant-demo
vagrant up
```

Allez vous pr√©parer un ‚òïÔ∏è (la üç∫ marche aussi). 

## 1ers contacts

Donc quelques minutes

Normalement,vous avez 7 machines de lanc√©es (faites un `vagrant status` pour voir)

```shell
webapp1         192.168.1.21:8080
webapp2         192.168.1.22:8080
webapp3         192.168.1.23:8080
webapp_new1     192.168.1.31:8080
webapp_new2     192.168.1.32:8080
webapp_new3     192.168.1.33:8080
sozuapp         192.168.1.99:8080 
```

> Remarques:
> - les 6 1√®res VMs contiennent une application web **Express** d√©marr√©e
> - les VMS 1, 2, 3 contiennent la version 1 de l'application web
> - les VMS 4, 5, 6 contiennent la version 2 de l'application web
> - la derni√®re VM `sozuapp` contient rust, cargo et S≈çzu compil√©
> - vous pouvez diminuer le nombre de VM en modifiant le `Vagrantfile`

‚ö†Ô∏è J'ai aussi modifi√© mon fichier `hosts` en ajoutant ceci:

```shell
192.168.1.99 sozu.local
```

Donc pour se connecter au reverse proxy (S≈çzu), vous utiliserez cette adresse: [http://sozu.local:8080/](http://sozu.local:8080/)

si vous regardez le fichier de configuration de **S≈çzu** (`demo.toml`), il y a la rubrique `[applications.webapp]`:

```shell
hostname = "sozu.local"
frontends = [ "HTTP" ]
backends  = [ "192.168.1.21:8080", "192.168.1.22:8080", "192.168.1.23:8080"]
```

ce qui signifie que vous pouvez vous connecter via **S≈çzu** √† une des 3 webapps `webapp1`, `webapp2` ou `webapp3` (c'est **S≈çzu** qui choisi), vous pouvez faire le test en ouvrant plusieurs navigateurs (le code source des webapps est le m√™me mais il affiche un nom diff√©rent pour chacune)

<img src="https://github.com/k33g/k33g.github.com/raw/master/images/sozu01b.png" height="95%" width="95%">

## Enlever des machines

Nous allons nosus connecter en ssh √† la machine `sozuapp`, pour cela tapez la commande suivante:

```shell
vagrant ssh sozuapp
```

puis:

```shell
cd sozu-project/
sudo ./sozu/target/debug/sozuctl --config ./demo.toml  backend remove --id webapp --ip 192.168.1.21 --port 8080
sudo ./sozu/target/debug/sozuctl --config ./demo.toml  backend remove --id webapp --ip 192.168.1.22 --port 8080
sudo ./sozu/target/debug/sozuctl --config ./demo.toml  backend remove --id webapp --ip 192.168.1.23 --port 8080
```

> Remarque: `webapp` correspond au titre de la rubrique `[applications.webapp]` du fichier `demo.toml` de configuration de **S≈çzu**

<img src="https://github.com/k33g/k33g.github.com/raw/master/images/sozu02b.png" height="95%" width="95%">

## Ajouter des machines

Si vous vous souvenez bien, en plus de la machine **S≈çzu** il reste 3 machines suppl√©mentaires qui "tournent":

```shell
webapp_new1     192.168.1.31:8080
webapp_new2     192.168.1.32:8080
webapp_new3     192.168.1.33:8080
```

Nous allons les enregistrer (ajouter) dans  **S≈çzu** (sans re-d√©marrage):

```shell
vagrant ssh sozuapp # su vous n'√™tes plus connect√©
```

Puis:

```shell
cd sozu-project/
sudo ./sozu/target/debug/sozuctl --config ./demo.toml  backend add --id webapp --ip 192.168.1.31 --port 8080
sudo ./sozu/target/debug/sozuctl --config ./demo.toml  backend add --id webapp --ip 192.168.1.32 --port 8080
sudo ./sozu/target/debug/sozuctl --config ./demo.toml  backend add --id webapp --ip 192.168.1.33 --port 8080
```

Et cette fois ci **S≈çzu** va vous rediriger vers les nouvelles applications:

<img src="https://github.com/k33g/k33g.github.com/raw/master/images/sozu03b.png" height="95%" width="95%">

C'est aussi simple que √ßa.

Pour arr√™ter et supprimer vos VMs:

```shell
vagrant halt; vagrant destroy -f
# pour recommencer: vagrant up
```

Prochaine d√©mo d'ici une semaine ou deux (j'ai 2,3 trucs √† apprendre avant)

üëã
